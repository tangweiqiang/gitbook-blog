# Mysql笔记

聚簇索引  
b+树的原理  
b树和b+树的区别

#### 5.3 mysql的MVCC

#### 5.4 mysql的事务

事务的基本特性（ACID）:

⑴ 原子性（Atomicity）  
原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚

⑵ 一致性（Consistency）  
一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态。

⑶ 隔离性（Isolation）  
隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。

⑷ 持久性（Durability）  
持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。

事务的隔离级别：

⑴ 读未提交（READ\_UNCOMMITTED）  
原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚

⑵ 读提交（READ\_COMMITED）  
一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态。

⑶ 重复读（REPEATABLE\_READ）  
隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。

⑷ 序列化（SERLALIZABLE）  
持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。 不同的事务带来的影响：

⑴ 脏读（Atomicity）  
原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚

⑵ 不可重复读（Consistency）  
一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态。

⑶ 幻读（Isolation）  
隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。

#### 5.5 分布式mysql与一致性hash

通过crc32算法，可以将一个id转化为0-2^32-1的数据 然后划分在哪一段的数据，属于哪个node，哪个node属于哪个库表 对于user，直接获取到对应的位置，然后插入数据 对于album，先通过user计算，然后获取位置，插入数据 分布式mysql我们公司的做法是：

* 建一张node表，用于存储各个节点与node之间的关系
* 通过id和crc32算法去查找对应的node，从而获取到哪个node在对应的区间里面
* id的生成是统一管理的，喜马拉雅是存放在一张表里面
* 如何生成node需要研究

#### MVCC

MVCC \(Multiversion Concurrency Control\)，即多版本并发控制技术,它使得大部分支持行锁的事务引擎，不再单纯的使用行锁来进行数据库的并发控制，取而代之的是把数据库的行锁与行的多个版本结合起来，只需要很小的开销,就可以实现非锁定读，从而大大提高数据库系统的并发性能

#### 红黑树

特性： 1）叶节点和根节点为黑，红节点下面只能为黑；  
2）从一个节点到该节点的子孙节点的所有路径上包含相同数目的黑节点  
3）确保没有一条路径会比其他路径长出俩倍。因而，红黑树是相对是接近平衡的二叉树；  
4）时间复杂度为O\(lgn\)，一棵含有n个节点的红黑树的高度至多为2log\(n+1\)。

#### B+树

阶： 树的最大分支树  
节点的度： 节点的分支数 对于1颗m阶b+树：

* 根节点至少有两个子节点  
* 每个节点有M-1个key，并且以升序排列  
* 位于M-1和M key的子节点的值位于M-1 和M key对应的Value之间  
* 其它节点至少有M/2个子节点 

对于一颗节点为N度为M的子树，查找和插入需要log\(M-1\)N ~ log\(M/2\)N次比较。

**MySQL优化**

1\)索引字段上运算可能会使索引失效   
****2\)能用union all不要用union   
3\)避免使用null   
4\)like的话，尽量   
5\)分页操作的改良手段：索引，order by prepare   
6\)大表尽量通过索引查找成小表再做复合操作   
7\)避免使用!=或者not in这之类的语句，使得索引失效   
8\)能使用覆盖索引尽量使用覆盖索引

