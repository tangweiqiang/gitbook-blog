# 高并发高可用

## 高并发

### SLB

通过SLB进行负载均衡

### 站点层水平扩展

通过对server职责的分离，划分成多个应用

### 服务层水平扩展

将一个server部署在多台服务器上，提高并发能力，以及可用性

### 数据库层

水平垂直分割，读写分离，分库分表  
携程对于超过80个字段的表建议垂直拆分

### 额外

vernish缓存，服务异步化，redis缓存，本地缓存，熔断，降级，限流应该属于高可用的范围  
link: [https://www.cnblogs.com/kaleidoscope/p/11976869.html](https://www.cnblogs.com/kaleidoscope/p/11976869.html)

## 高可用

双DR容错容灾

缓存，降级，限流

### 可用性度量与考核

#### 网站可用性度量：

* 2个9=基本可用
* 3个9=较高可用
* 4个9=具有自动恢复能力的高可用
* **5个9=极高可用-&gt;理想状态**

    携程的可用性目标是99.95%

#### 网站可用性计算：

* 网站不可用时间=故障修复时间点-故障发现时间点
* 网站年度可用性指标=（1-网站不可用时间/年度总时间）\*100%

### 高可用的架构

（1）设计的目的？ **保证服务器硬件故障服务依然可用，数据依然保存并能够被访问**。

（2）主要的手段？ **数据和服务的①冗余备份以及②失效转移**：

### 高可用的应用

 应用层处理网站应用的业务逻辑，应用的一个最显著的特点是：**应用的无状态性**。

 （1）通过**负载均衡**进行无状态服务的失效转移  
（2）应用服务器集群的Session管理 ③Cookie记录Session  ④**Session服务器**

### 高可用的服务

高可用的服务模块为业务产品提供基础公共服务，在大型站点中这些服务通常都独立分布式部署，被具体应用远程调用。

在具体实践中，有以下几点高可用的服务策略可以参考：

①分级管理：核心应用和服务具有更高的优先级，比如用户及时付款比能否评价商品更重要；

②超时设置：设置服务调用的超时时间，一旦超时后，通信框架抛出异常，应用程序则根据服务调度策略选择重试or请求转移到其他服务器上；

③异步调用：通过消息队列等异步方式完成，避免一个服务失败导致整个应用请求失败的情况。

④服务降级：网站访问高峰期间，为了保证核心应用的正常运行，需要对服务降级。

降级有两种手段：一是拒绝服务，拒绝较低优先级的应用的调用，减少服务调用并发数，确保核心应用的正常运行；二是关闭功能，关闭部分不重要的服务，或者服务内部关闭部分不重要的功能，以节约系统开销，为核心应用服务让出资源；

⑤幂等性设计：保证服务重复调用和调用一次产生的结果相同

### 高可用的数据

保证数据高可用的主要手段有两种：一是数据备份，二是失效转移机制；

①数据备份：又分为冷备份和热备份，冷备份是定期复制，不能保证数据可用性。热备份又分为异步热备和同步热备，异步热备是指多份数据副本的写入操作异步完成，而同步方式则是指多份数据副本的写入操作同时完成。

关系数据库的热备机制就是通常所说的主从同步机制，实践中通常使用读写分离的方法来访问Master和Slave数据库，也就是说写操作只访问Master库，读操作均访问Slave库。

②失效转移：若数据服务器集群中任何一台服务器宕机，那么应用程序针对这台服务器的所有读写操作都要重新路由到其他服务器，保证数据访问不会失败。

### 高可用的QA

①网站发布：在柔性的发布过程中，每次关闭的服务都是集群中的一小部分，并在发布完成后立即可以访问；

②自动化测试：使用自动测试工具或脚本完成测试；

③预发布验证：引入预发布服务器，与正式服务器几乎一致，只是没有配置在负载均衡服务器上，外部用户无法访问；

④代码控制：目前大多数网站采用SVN，分支开发，主干发布模式；另外，目前开源社区广泛采用Git作为版本控制工具，正逐步取代SVN的地位；

### 网站运行监控

（1）监控数据采集

①用户行为日志收集：服务器端的日志收集和客户端的日志收集；目前许多网站逐步开发基于实时计算框架Storm的日志统计与分析工具；

②服务器性能监控：收集服务器性能指标，如系统Load、内存占用、磁盘IO等，及时判断，防患于未然；

③运行数据报告：采集并报告，汇总后统一显示，应用程序需要在代码中处理运行数据采集的逻辑；

（2）监控管理

①系统报警：配置报警阀值和值守人员联系方式，系统发生报警时，即使工程师在千里之外，也可以被及时通知；

②失效转移：监控系统在发现故障时，主动通知应用进行失效转移；

③自动优雅降级：为了应付网站访问高峰，主动关闭部分功能，释放部分系统资源，保证核心应用服务的正常运行；—&gt;网站柔性架构的理想状态 

\*\*\*\*

### 思维导图

![&#x9AD8;&#x53EF;&#x7528;&#x601D;&#x7EF4;&#x5BFC;&#x56FE;](../.gitbook/assets/image%20%281%29.png)

